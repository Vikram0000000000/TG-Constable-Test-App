<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Portal Pro</title>
    <style>
        :root { --primary: #1a202c; --blue: #3182ce; --red: #e53e3e; --bg: #f0f4f8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: #2d3748; overflow-x: hidden; }
        
        .screen { display: none; padding-bottom: 80px; }
        .active { display: block !important; }
        
        .header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .breadcrumb { background: white; padding: 10px 15px; font-size: 13px; font-weight: bold; color: var(--blue); border-bottom: 1px solid #ddd; cursor: pointer; }
        
        .container { padding: 15px; }
        .card-item { background: white; padding: 20px 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; transition: 0.2s; margin-bottom: 12px; }
        .card-item:active { transform: scale(0.95); }
        
        .mode-toggle { display: flex; margin: 15px; background: #edf2f7; border-radius: 10px; padding: 5px; }
        .mode-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .mode-btn.active-prac { background: var(--blue); color: white; }
        .mode-btn.active-exam { background: var(--red); color: white; }

        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 15px; box-sizing: border-box; gap: 12px; border-top: 1px solid #e2e8f0; z-index: 1000; }

        .palette { 
            position: fixed; right: 0; top: 0; width: 280px; height: 100%; 
            background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.2); 
            z-index: 3000; transition: transform 0.3s ease-in-out; 
            display: flex; flex-direction: column; transform: translateX(100%); 
        }
        .palette.open { transform: translateX(0); }

        .subject-slider { display: none; gap: 10px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; }
        .subject-slider::-webkit-scrollbar { display: none; }

        .q-card { background: white; margin: 15px; padding: 22px; border-radius: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; }
        #q-text { font-weight: 700; font-size: 18px; line-height: 1.5; color: #1a202c; margin-bottom: 20px; }

        .option { 
            display: block; width: 100%; padding: 16px; margin: 12px 0; 
            border: 2px solid #e2e8f0; border-radius: 12px; background: #fff; 
            text-align: left; cursor: pointer; font-size: 15px; transition: 0.2s;
        }
        .option.selected { border-color: var(--blue); background: #ebf8ff; font-weight: bold; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 2000; }
        .overlay.show { display: block; }
        /* Floating button at top-left */
#btn-progress {
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 1001; /* High z-index to stay above everything */
    background: #3498db;
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}

/* The Pop-up Overlay */
#progress-popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 2000;
    color: white;
    padding: 20px;
    overflow-y: auto;
    box-sizing: border-box;
    font-family: sans-serif;
}

/* Individual attempt cards */
.history-card {
    background: #2c3e50;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 12px;
    border-left: 6px solid #3498db;
}

    </style>
</head>
<body>
<button id="btn-progress" onclick="openProgress()">üìä Progress</button>

<div id="progress-popup">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:10px;">
        <h2 style="margin:0;">Exam History (Last 100)</h2>
        <button onclick="closeProgress()" style="background:#e74c3c; color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">CLOSE X</button>
    </div>
    
    <div id="history-list">
        </div>
    
    <button onclick="clearAllHistory()" style="width:100%; margin-top:30px; background:none; color:#95a5a6; border:1px solid #95a5a6; padding:10px; border-radius:5px; cursor:pointer;">Clear All History</button>
</div>


<div id="overlay" class="overlay" onclick="toggleMenu()"></div>

<div id="palette" class="palette">
    <div style="padding: 20px; display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee;">
        <h3 style="margin:0;">QUESTION MAP</h3>
        <button onclick="toggleMenu()" style="border:none; background:none; font-size:24px;">&times;</button>
    </div>
    <div style="flex: 1; overflow-y: auto; padding: 20px;">
        <div id="palette-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;"></div>
    </div>
    <div style="padding: 20px; border-top: 1px solid #eee;">
        <button class="btn" style="background:var(--blue); color:white; width:100%; margin-bottom:10px;" onclick="submitQuiz()">SUBMIT TEST</button>
        <button class="btn" style="background:#cbd5e0; width:100%;" onclick="exitQuiz()">EXIT</button>
    </div>
</div>

<div id="scr-home" class="screen active">
    <div class="header">EXAM PORTAL</div>
    <div class="mode-toggle">
        <div id="m-prac" class="mode-btn active-prac" onclick="changeMode('practice')">PRACTICE</div>
        <div id="m-exam" class="mode-btn" onclick="changeMode('exam')">EXAM</div>
    </div>
    <div id="breadcrumb" class="breadcrumb" onclick="goHome()">üè† HOME</div>
    <div id="menu-grid" class="container"></div>
</div>

<div id="scr-quiz" class="screen">
    <div class="header">
        <button onclick="exitQuiz()" style="background:none; border:none; color:white; font-size:18px;">‚¨Ö</button>
        <span id="quiz-title">QUIZ</span>
        <button onclick="toggleMenu()" style="background:none; border:none; color:white; font-size:20px;">&#9776;</button>
    </div>
    <div id="subject-scroll-bar" class="subject-slider" style="background: white; border-bottom: 1px solid #ddd;"></div>
    
    <div class="q-card">
        <div id="q-text"></div>
        <div id="opt-container"></div>
    </div>
    <div id="quiz-nav" class="nav-bar">
        </div>
</div>

<script src="questions.js"></script>
<script>
    let mode = 'practice';
    let path = [];
    let currentQuestions = [];
    let currentIdx = 0;
    let userAnswers = [];
    let isAnswered = false; 
    let testHistory = JSON.parse(localStorage.getItem('testHistory')) || {};

    function changeMode(m) {
        mode = m;
        path = [];
        document.getElementById('m-prac').className = `mode-btn ${m==='practice'?'active-prac':''}`;
        document.getElementById('m-exam').className = `mode-btn ${m==='exam'?'active-exam':''}`;
        render();
    }

    function render() {
        const grid = document.getElementById('menu-grid');
        grid.innerHTML = "";
        let level = library[mode];
        path.forEach(p => level = level[p]);

        const folderSection = document.createElement('div');
        folderSection.style.cssText = "display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;";
        const testSection = document.createElement('div');

        for (let key in level) {
            let isFolder = !Array.isArray(level[key]);
            const displayName = key.replace(/_/g, " ").toUpperCase();

            if (isFolder) {
                let folderBtn = document.createElement('div');
                folderBtn.style.cssText = "padding: 10px 20px; background: white; border: 1px solid #cbd5e0; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; color: #4a5568;";
                folderBtn.innerHTML = `üìÅ ${displayName}`;
                folderBtn.onclick = () => { path.push(key); render(); };
                folderSection.appendChild(folderBtn);
            } else {
                let card = document.createElement('div');
                card.className = "card-item";
                const history = testHistory[displayName];
                card.innerHTML = `
                    <div style="text-align:left;">
                        <div style="font-size:16px; margin-bottom:5px;">${displayName}</div>
                        ${history ? `<small style="color:green">Last Score: ${history.score}/${history.total}</small>` : `<small style="color:gray">Not Started</small>`}
                    </div>
                `;
                card.onclick = () => startQuiz(level[key], key);
                testSection.appendChild(card);
            }
        }
        grid.appendChild(folderSection);
        grid.appendChild(testSection);
        updateBC();
    }

    function startQuiz(qs, name) {
     // HIDE THE PROGRESS BUTTON IMMEDIATELY
    document.getElementById('btn-progress').style.display = 'none';

    currentQuestions = qs;
    currentIdx = 0;
    userAnswers = new Array(qs.length).fill(null);
        currentQuestions = qs;
        currentIdx = 0;
        userAnswers = new Array(qs.length).fill(null);
        document.getElementById('scr-home').classList.remove('active');
        document.getElementById('scr-quiz').classList.add('active');
        document.getElementById('quiz-title').innerText = name.replace(/_/g, " ").toUpperCase();
        loadQuestion();
    }

    function loadQuestion() {
        isAnswered = false; 
        const q = currentQuestions[currentIdx];
        
        const filterBar = document.getElementById('subject-scroll-bar');
        if (filterBar) filterBar.style.display = q.topic ? 'none' : 'flex';

        document.getElementById('q-text').innerHTML = `<small style="color:var(--blue)">Q${currentIdx+1}/${currentQuestions.length}</small><br>${q.q}`;
        
        const container = document.getElementById('opt-container');
        container.innerHTML = "";
        
        q.o.forEach((opt, i) => {
            let btn = document.createElement('div');
            btn.className = "option" + (userAnswers[currentIdx] === i ? " selected" : "");
            btn.innerHTML = opt;
            btn.onclick = () => handleSelection(i);
            container.appendChild(btn);
        });

        let expDiv = document.createElement('div');
        expDiv.id = "inline-explanation";
        expDiv.style.cssText = "display:none; background:#fff5f5; border:1px solid #feb2b2; padding:15px; border-radius:12px; margin-top:15px; font-size:14px; line-height:1.6;";
        container.appendChild(expDiv);
        
        updateNavBar();
        renderPalette();
    }

    function handleSelection(idx) {
        if (isAnswered) return;
        const q = currentQuestions[currentIdx];
        userAnswers[currentIdx] = idx;
        isAnswered = true;

        const options = document.getElementsByClassName('option');
        if (mode === 'exam') {
            options[idx].classList.add('selected');
            setTimeout(() => move(1), 300);
        } else {
            const expDiv = document.getElementById('inline-explanation');
            if (idx === q.a) {
                options[idx].style.background = "#48bb78";
                options[idx].style.color = "white";
                setTimeout(() => move(1), 1000);
            } else {
                options[idx].style.background = "#f56565";
                options[idx].style.color = "white";
                options[q.a].style.border = "2px solid #48bb78";
                if (expDiv) {
                    expDiv.innerHTML = `<b>EXPLANATION:</b><br>${q.sol}`;
                    expDiv.style.display = 'block';
                    expDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }
        renderPalette();
    }

    function updateNavBar() {
        const nav = document.getElementById('quiz-nav');
        const isLast = currentIdx === currentQuestions.length - 1;
        nav.innerHTML = `
            <button class="btn" style="background:#cbd5e0;" onclick="move(-1)">PREV</button>
            ${isLast 
                ? `<button class="btn" style="background:#48bb78; color:white; font-weight:bold;" onclick="submitQuiz()">FINISH & SUBMIT</button>` 
                : `<button class="btn" style="background:var(--blue); color:white;" onclick="move(1)">NEXT</button>`
            }
        `;
    }

    function move(step) {
        let n = currentIdx + step;
        if (n >= 0 && n < currentQuestions.length) {
            currentIdx = n;
            loadQuestion();
        }
    }

    function submitQuiz() {
    // 1. Clear any pending transitions so the page doesn't jump
    let id = window.setTimeout(function() {}, 0);
    while (id--) { window.clearTimeout(id); }

    let score = 0;
    currentQuestions.forEach((q, i) => { 
        if (userAnswers[i] === q.a) score++; 
    });

    const name = document.getElementById('quiz-title').innerText;
     // Make sure 'currentTopic' matches the variable name you use for subjects
    const subjectName = document.getElementById('quiz-title').innerText;
    saveResultToHistory(subjectName, score, currentQuestions.length);
    testHistory[name] = { 
        score, 
        total: currentQuestions.length, 
        date: new Date().toLocaleDateString() 
    };
    localStorage.setItem('testHistory', JSON.stringify(testHistory));

    // 2. Render the page and STOP all other scripts
    renderScorePage('all');
}


    function renderScorePage(subjectFilter) {
        const firstQ = currentQuestions[0];
        const isFullPaper = firstQ && firstQ.subject && !firstQ.topic;
        
        let correct = 0, wrong = 0, skipped = 0;
        currentQuestions.forEach((q, i) => {
            const qSub = q.subject || "General";
            if (subjectFilter !== 'all' && qSub !== subjectFilter) return;
            if (userAnswers[i] === null) skipped++;
            else if (userAnswers[i] === q.a) correct++;
            else wrong++;
        });

        const subList = ["English", "Arithmetic", "Reasoning", "General Science", "History", "Geography", "Polity"];
        let slider = "";
        if (isFullPaper) {
            slider = `
                <div class="subject-slider" style="display:flex; background:white; padding:10px;">
                    <div onclick="renderScorePage('all')" style="padding:8px 15px; background:${subjectFilter==='all'?'#3182ce':'#edf2f7'}; color:${subjectFilter==='all'?'white':'black'}; border-radius:20px; margin-right:5px; cursor:pointer;">ALL</div>
                    ${subList.map(s => `<div onclick="renderScorePage('${s}')" style="padding:8px 15px; background:${subjectFilter===s?'#3182ce':'#edf2f7'}; color:${subjectFilter===s?'white':'black'}; border-radius:20px; margin-right:5px; cursor:pointer;">${s.toUpperCase()}</div>`).join('')}
                </div>`;
        }

        document.body.innerHTML = `
            <div style="padding:15px; background:#f0f4f8; min-height:100vh;">
                <div style="background:var(--primary); color:white; padding:20px; border-radius:15px; text-align:center;">
                    <h2>REPORT: ${subjectFilter.toUpperCase()}</h2>
                    <div style="display:flex; justify-content:space-around;">
                        <div style="color:#48bb78;">CORRECT<br><b>${correct}</b></div>
                        <div style="color:#f56565;">WRONG<br><b>${wrong}</b></div>
                        <div>SKIPPED<br><b>${skipped}</b></div>
                    </div>
                    <button onclick="location.reload()" style="margin-top:15px; padding:10px; width:100%; border-radius:10px; border:none; background:var(--blue); color:white;">üè† HOME</button>
                </div>
                ${slider}
                <div style="margin-top:20px;">${generateFilteredCards(subjectFilter)}</div>
            </div>`;
    }

    function generateFilteredCards(subjectFilter) {
    let html = "";
    currentQuestions.forEach((q, i) => {
        if (subjectFilter !== 'all' && (q.subject || "General") !== subjectFilter) return;
        
        const ans = userAnswers[i];
        const isCorr = ans === q.a;
        
        // --- RESTORING FULL COLORS ---
        let bgColor = "#edf2f7"; // Default for Skipped (Gray)
        let textColor = "#2d3748";
        
        if (ans !== null) {
            if (isCorr) {
                bgColor = "#c6f6d5"; // Full Green background
                textColor = "#22543d";
            } else {
                bgColor = "#fed7d7"; // Full Red background
                textColor = "#822727";
            }
        }

        html += `
            <div style="background:${bgColor}; color:${textColor}; padding:20px; border-radius:15px; margin-bottom:15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div style="font-weight:bold; font-size:16px; margin-bottom:8px;">Q${i+1}. ${q.q}</div>
                
                <div style="background:rgba(255,255,255,0.5); padding:10px; border-radius:8px; font-size:14px;">
                    <div><b>Your Answer:</b> ${ans === null ? '<i>Skipped</i>' : q.o[ans]}</div>
                    <div style="margin-top:4px;"><b>Correct Answer:</b> ${q.o[q.a]}</div>
                </div>

                <div style="margin-top:12px; font-size:13px; line-height:1.5; border-top:1px solid rgba(0,0,0,0.1); padding-top:10px;">
                    <b>Step-by-Step Solution:</b><br>${q.sol}
                </div>
            </div>`;
    });
    return html;
}

    function renderPalette() {
        const grid = document.getElementById('palette-grid');
        grid.innerHTML = "";
        currentQuestions.forEach((_, i) => {
            let dot = document.createElement('div');
            dot.style.cssText = `padding:10px; text-align:center; border-radius:5px; cursor:pointer; background:${userAnswers[i]!==null?'#48bb78':'#edf2f7'}; color:${userAnswers[i]!==null?'white':'black'}; border:${i===currentIdx?'2px solid #3182ce':'1px solid #ccc'}`;
            dot.innerText = i + 1;
            dot.onclick = () => { currentIdx = i; loadQuestion(); toggleMenu(); };
            grid.appendChild(dot);
        });
    }

    function toggleMenu() {
        document.getElementById('palette').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    }

    function updateBC() { document.getElementById('breadcrumb').innerHTML = "üè† HOME " + path.map(p => " > " + p.toUpperCase()).join(""); }
    function goHome() { path = []; render(); }
    function exitQuiz() { location.reload(); }
    window.onload = render;
    // 1. OPEN POP-UP
function openProgress() {
    document.getElementById('progress-popup').style.display = 'block';
    renderHistory();
}

// 2. CLOSE POP-UP
function closeProgress() {
    document.getElementById('progress-popup').style.display = 'none';
}

// 3. RENDER THE HISTORY LIST
function renderHistory() {
    const list = document.getElementById('history-list');
    const history = JSON.parse(localStorage.getItem('exam_history')) || [];
    
    if (history.length === 0) {
        list.innerHTML = "<div style='text-align:center; padding:50px; opacity:0.5;'>No exam history found yet. Complete a test!</div>";
        return;
    }

    list.innerHTML = history.map((item, index) => {
        const attemptNum = history.length - index;
        const color = item.percentage >= 40 ? "#2ecc71" : "#e74c3c"; // Green for Pass, Red for Fail
        
        return `
            <div class="history-card" style="border-left-color: ${color}">
                <div style="display:flex; justify-content:space-between; font-size:0.9em; opacity:0.8;">
                    <span>Attempt #${attemptNum}</span>
                    <span>${item.date}</span>
                </div>
                <div style="margin-top:8px; font-size:1.1em; font-weight:bold;">${item.subject}</div>
                <div style="margin-top:5px; display:flex; justify-content:space-between; align-items:center;">
                    <span>Score: ${item.score}/${item.total}</span>
                    <span style="background:${color}; padding:2px 8px; border-radius:4px; font-size:0.9em;">${item.percentage}%</span>
                </div>
            </div>
        `;
    }).join('');
}

// 4. THE SAVING ENGINE (Call this in your submitQuiz function)
function saveResultToHistory(subject, score, total) {
    let history = JSON.parse(localStorage.getItem('exam_history')) || [];
    
    const newRecord = {
        subject: subject,
        score: score,
        total: total,
        percentage: Math.round((score / total) * 100),
        date: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };

    history.unshift(newRecord); // Add new result to the top

    // MANAGE 100 ATTEMPT LIMIT
    if (history.length > 100) {
        history.pop(); // Remove the oldest attempt if more than 100
    }

    localStorage.setItem('exam_history', JSON.stringify(history));
}

// 5. CLEAR FUNCTION
function clearAllHistory() {
    if(confirm("Are you sure you want to delete all 100 records?")) {
        localStorage.removeItem('exam_history');
        renderHistory();
    }
}

</script>
</body>
</html>
